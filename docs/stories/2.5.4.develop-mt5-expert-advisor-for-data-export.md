# Story 2.5.4: Develop MT5 Expert Advisor for Data Export

## Status
Draft

## Story
**As a** developer,
**I want** to create an Expert Advisor for MT5 that reads chart data (OHLC) and sends it to the FastAPI ingestion endpoint,
**so that** real-time and historical data can be fed into the system.

## Acceptance Criteria
1. The EA is written in MQL5
2. It can be attached to a chart in MT5
3. It successfully sends data to the `POST /api/v1/candles` endpoint
4. API credentials are managed securely

## Tasks / Subtasks
- [ ] Create MQL5 Expert Advisor structure and basic framework (AC: 1, 2)
  - [ ] Set up EA header with metadata (name, version, description)
  - [ ] Implement OnInit() function for EA initialization
  - [ ] Implement OnDeinit() function for cleanup
  - [ ] Add input parameters for configuration (API endpoint, API key, symbols, timeframes)
  - [ ] Create basic chart attachment capability and validation
- [ ] Implement OHLC data collection logic (AC: 1, 2)
  - [ ] Create function to read current symbol OHLC data from MT5
  - [ ] Implement timeframe detection and data collection for H1 timeframes
  - [ ] Add data validation to ensure OHLC values are valid
  - [ ] Create timestamp conversion from MT5 datetime to ISO 8601 format
  - [ ] Add volume data collection functionality
- [ ] Build HTTP POST functionality for data transmission (AC: 3)
  - [ ] Implement WebRequest functionality in MQL5 for HTTP POST
  - [ ] Create JSON payload formatting for candles array structure
  - [ ] Add X-API-KEY header authentication implementation
  - [ ] Implement retry logic for failed HTTP requests
  - [ ] Add logging for successful and failed data transmissions
- [ ] Implement secure API credential management (AC: 4)
  - [ ] Use EA input parameters for API endpoint URL configuration
  - [ ] Implement secure API key input parameter (masked in UI)
  - [ ] Add validation for API endpoint URL format
  - [ ] Create error handling for invalid API credentials
  - [ ] Add configuration validation on EA startup
- [ ] Add comprehensive error handling and logging
  - [ ] Implement error handling for MT5 data access issues
  - [ ] Add network error handling for HTTP requests
  - [ ] Create comprehensive logging system for debugging
  - [ ] Add user-friendly error messages in EA logs
  - [ ] Implement graceful degradation for temporary network issues
- [ ] Create EA deployment and usage documentation
  - [ ] Write installation guide for MT5 EA deployment
  - [ ] Document EA configuration parameters and their usage
  - [ ] Create troubleshooting guide for common issues
  - [ ] Add examples of proper API endpoint configuration
  - [ ] Document security best practices for API key management

## Dev Notes

### Previous Story Insights
Stories 2.5.1, 2.5.2, and 2.5.3 established the complete FastAPI service infrastructure including the data ingestion endpoint (`POST /api/v1/candles`) and query endpoint. The database schema, authentication mechanisms, and API specifications are fully defined and ready to receive data from this MT5 Expert Advisor. The ingestion endpoint expects specific JSON payload format with X-API-KEY authentication.

### Data Models
The EA must send data compatible with the established API specification:
- **API Endpoint**: `POST /api/v1/candles` as defined in previous stories
- **Authentication**: X-API-KEY header with secret API key value
- **Payload Format**: JSON object with "candles" array containing symbol, timeframe, timestamp, open, high, low, close, volume fields
- **Timestamp Format**: ISO 8601 format (e.g., "2025-08-03T10:00:00Z") for API compatibility
- **Data Types**: OHLC as decimal/double values, volume as integer, symbol and timeframe as strings
[Source: architecture/5-api-specification.md#post-api-v1-candles]

### API Specifications
The EA must integrate with the established FastAPI ingestion endpoint:
- **Target Endpoint**: `POST /api/v1/candles` on the deployed FastAPI service
- **Authentication Method**: X-API-KEY header authentication (not JWT or session-based)
- **Request Headers**: X-API-KEY and Content-Type: application/json
- **Success Response**: 201 Created with success message and records_added count
- **Error Responses**: 401 Unauthorized for invalid API key, 422 for validation errors
- **Payload Structure**: Must match exact JSON schema expected by FastAPI service
[Source: architecture/5-api-specification.md#fastapi-market-data-service]

### Component Specifications
MetaTrader 5 Expert Advisor technical requirements:
- **Language**: MQL5 version 5.0 as specified in tech stack
- **Platform Integration**: Must work with MT5 terminal and chart attachment system
- **HTTP Capabilities**: Use MQL5 WebRequest functions for HTTP POST operations
- **Data Access**: Utilize MT5's built-in OHLC data access functions and symbol information
- **Configuration**: Input parameters for API endpoint URL, API key, and operational settings
- **Error Handling**: Robust error handling for network issues and MT5 data access problems
- **Logging**: Comprehensive logging to MT5 Experts tab for debugging and monitoring
[Source: architecture/3-tech-stack.md#data-ingestion]

### File Locations
Based on project structure and MT5 development conventions:
- **EA Source File**: Create new directory `mt5-ea/` in project root for MT5 Expert Advisor files
- **Main EA File**: `mt5-ea/TradingSystemDataExporter.mq5` (main Expert Advisor source)
- **Include Files**: `mt5-ea/includes/` for any shared MQL5 include files if needed
- **Documentation**: `mt5-ea/README.md` for installation and configuration instructions
- **Configuration Template**: `mt5-ea/config-template.txt` for API endpoint configuration examples 
[Source: architecture/12-source-tree.md#project-structure]

### Testing Requirements
MT5 Expert Advisor testing approach (adapted from testing strategy):
- **Manual Testing**: Test EA attachment to charts, configuration validation, data transmission
- **Integration Testing**: Verify successful communication with FastAPI ingestion endpoint
- **Error Scenario Testing**: Test network failures, invalid API keys, malformed data scenarios
- **Performance Testing**: Test continuous data transmission under normal trading conditions
- **Security Testing**: Verify API key protection and secure credential handling
- **Documentation Testing**: Validate installation and configuration instructions
[Source: architecture/15-coding-standards.md#testing-strategy]

### Technical Constraints
- **MQL5 Version**: Must be compatible with MQL5 version 5.0 as specified in tech stack
- **MT5 Platform**: Compatible with MetaTrader 5 trading terminal (Windows/Mac versions)
- **Network Requirements**: Requires internet connectivity and MT5 WebRequest permissions enabled
- **API Compatibility**: Must strictly adhere to FastAPI endpoint specification for data format
- **Security**: API keys must be handled securely within MT5 input parameters system
- **Performance**: Minimal impact on MT5 terminal performance during data transmission
- **Data Accuracy**: Ensure precise OHLC data transmission without data loss or corruption
[Source: architecture/3-tech-stack.md#data-ingestion]

### Integration Requirements
Preparation for integration with existing FastAPI service:
- **Endpoint Compatibility**: Must send data in exact format expected by POST /api/v1/candles
- **Authentication**: Use X-API-KEY header authentication matching FastAPI security implementation
- **Error Handling**: Handle HTTP response codes appropriately (201 success, 401 auth, 422 validation)
- **Data Format**: JSON payload with candles array structure matching FastAPI Pydantic models
- **Network Reliability**: Implement retry logic for temporary network issues
- **Monitoring**: Provide logging output that helps identify transmission issues
[Source: architecture/7-external-apis.md#data-ingestion-flow]

### Security Considerations
API credential and data security requirements:
- **API Key Storage**: Use MT5 input parameters with secure string type for API key entry
- **Network Security**: Ensure HTTPS communication with FastAPI endpoint
- **Credential Validation**: Validate API endpoint URL format and accessibility on EA startup
- **Error Message Security**: Avoid exposing sensitive information in error messages or logs
- **Data Integrity**: Ensure accurate data transmission without manipulation or corruption
- **Access Control**: EA should only access necessary MT5 data and functions
[Source: architecture/15-coding-standards.md#security-requirements]

### Project Structure Notes
The MT5 Expert Advisor complements the FastAPI service created in previous stories, completing the data ingestion pipeline from MT5 terminal to the trading system database. This EA serves as the data source that feeds the entire charting and analysis system, making it a critical component for the application's core functionality.

## Testing

**Test Approach:** Manual and integration testing with MT5 terminal and FastAPI service

**Test Environment Requirements:**
- MetaTrader 5 terminal with demo or live account access
- Access to deployed FastAPI service endpoint
- Valid API key for authentication testing
- Chart data available for testing (EURUSD H1 recommended)

**Testing Standards:**
- Manual testing of EA functionality within MT5 environment
- Integration testing with actual FastAPI endpoint
- Security testing of API credential handling
- Performance testing under continuous operation
- Documentation validation for installation procedures

**Specific Testing Requirements:**
- Test EA compilation and installation in MT5 terminal
- Test EA attachment to different currency pair charts
- Test successful data transmission to POST /api/v1/candles endpoint
- Test API key authentication and validation
- Test error handling for invalid API credentials
- Test network error scenarios and retry logic
- Test OHLC data accuracy and timestamp conversion
- Test JSON payload format compatibility with FastAPI
- Test continuous operation without MT5 performance impact
- Test EA configuration parameter validation
- Test installation documentation accuracy
- Test troubleshooting guide effectiveness
- Verify data appears correctly in FastAPI service database
- Test EA behavior during MT5 terminal restart
- Test multiple timeframe data collection if implemented

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-04 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_