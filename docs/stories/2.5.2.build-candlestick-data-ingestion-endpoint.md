# Story 2.5.2: Build Candlestick Data Ingestion Endpoint

## Status
Draft

## Story
**As a** developer,
**I want** to build a secure `POST /api/v1/candles` endpoint to receive and store OHLC data from an external MT5 EA,
**so that** the system can be populated with custom market data.

## Acceptance Criteria
1. The endpoint is created and secured
2. It correctly validates and parses incoming data
3. Data is successfully stored in the `market_data_candles` table

## Tasks / Subtasks
- [ ] Create candle data ingestion endpoint (AC: 1, 2)
  - [ ] Implement `POST /api/v1/candles` endpoint in FastAPI routes
  - [ ] Add X-API-KEY authentication middleware for securing the endpoint
  - [ ] Create Pydantic models for request validation and parsing
  - [ ] Add proper error handling for authentication failures
  - [ ] Configure CORS settings for external MT5 EA access
- [ ] Implement data validation and parsing logic (AC: 2)
  - [ ] Create CandleData Pydantic model with required fields validation
  - [ ] Add timestamp format validation and parsing
  - [ ] Implement numeric data type validation for OHLC values
  - [ ] Add symbol and timeframe string validation
  - [ ] Handle batch candle data processing (array of candles)
- [ ] Integrate database storage functionality (AC: 3)
  - [ ] Set up database connection using service_role credentials
  - [ ] Implement INSERT operations to market_data_candles table
  - [ ] Handle duplicate data using UNIQUE constraint (symbol, timeframe, timestamp)
  - [ ] Add proper error handling for database connection issues
  - [ ] Implement transaction handling for batch inserts
- [ ] Add comprehensive testing for the endpoint (Required by testing strategy)
  - [ ] Create unit tests for endpoint authentication
  - [ ] Add tests for data validation and parsing logic
  - [ ] Create integration tests for database storage operations
  - [ ] Test error handling scenarios (invalid API key, malformed data)
  - [ ] Add performance tests for batch data ingestion

## Dev Notes

### Previous Story Insights
Story 2.5.1 established the FastAPI foundation with basic health endpoint and Docker configuration. The template structure, core configuration, and testing framework are already in place. This story builds upon that foundation by adding the first functional market data endpoint.

### Data Models
The endpoint will work directly with the `market_data_candles` table:
- **Table**: `market_data_candles` with columns: id (BIGSERIAL), symbol (TEXT), timeframe (TEXT), timestamp (TIMESTAMPTZ), open/high/low/close (NUMERIC), volume (BIGINT), created_at (TIMESTAMPTZ)
- **Constraints**: UNIQUE(symbol, timeframe, timestamp) to prevent duplicate candle data
- **RLS Policies**: service_role can INSERT, authenticated users can SELECT
- **Pydantic Model Structure**: CandleData with symbol, timeframe, timestamp, open, high, low, close, volume fields
[Source: architecture/9-database-schema.md#market-data-tables]

### API Specifications
The POST endpoint follows the detailed specification:
- **Endpoint**: `POST /api/v1/candles`
- **Authentication**: X-API-KEY header validation against environment variable
- **Request Format**: JSON with "candles" array containing individual candle objects
- **Response Format**: Success (201 Created) with records_added count, Error responses (401, 422)
- **Content Type**: application/json for both request and response
- **Batch Processing**: Support for multiple candles in single request
[Source: architecture/5-api-specification.md#fastapi-market-data-service]

### Component Specifications
FastAPI Market Data Service technical details:
- **Framework**: FastAPI with Pydantic for automatic request/response validation
- **Database Driver**: asyncpg for async PostgreSQL operations with connection pooling
- **Authentication**: Custom middleware for X-API-KEY header validation
- **Error Handling**: FastAPI automatic error responses with proper HTTP status codes
- **Logging**: Structured logging for data ingestion monitoring and debugging
- **Performance**: Async operations for handling concurrent ingestion requests
[Source: architecture/11-backend-architecture.md#market-data-service-fastapi]

### File Locations
Based on established FastAPI template structure:
- **Main Route**: `backend/src/app/api/routes/candles.py` (new endpoint file)
- **Pydantic Models**: `backend/src/app/models/candle.py` (new model file)
- **Database Operations**: `backend/src/app/db/candle_operations.py` (new database layer)
- **Authentication Middleware**: `backend/src/app/core/security.py` (extend existing)
- **Tests**: `backend/src/app/tests/api/routes/test_candles.py` (new test file)
- **Integration Tests**: `backend/src/app/tests/api/test_candle_integration.py`
- **Environment Config**: `backend/src/app/core/config.py` (add API_KEY variable)
[Source: architecture/12-source-tree.md#backend-directory]

### Testing Requirements
Follow established testing pyramid strategy:
- **Unit Tests**: Pytest for endpoint logic, validation, authentication middleware
- **Integration Tests**: Database operations with test database, end-to-end API calls
- **Test Coverage**: High coverage required for data validation and security logic
- **Test Framework**: Pytest with FastAPI TestClient for API testing
- **Test Database**: Separate test database with market_data_candles table
- **Security Testing**: Test authentication, authorization, and input validation
- **Performance Testing**: Load testing for batch data ingestion scenarios
[Source: architecture/15-coding-standards.md#testing-strategy]

### Technical Constraints
- **Python Version**: 3.11+ as specified in tech stack
- **FastAPI**: Latest version with automatic OpenAPI documentation generation
- **Database**: PostgreSQL 15.x via Supabase with service_role direct access
- **Connection Management**: Async database connections with proper pooling
- **Security**: Secure API key management via environment variables
- **Data Validation**: Strict Pydantic validation for all incoming data
- **Error Handling**: Proper HTTP status codes and error message formatting
- **Logging**: Structured logging for monitoring and debugging ingestion issues
[Source: architecture/3-tech-stack.md#backend-technologies]

### Database Service Role Configuration
Service role database access configuration:
- **Credentials**: Use SUPABASE_SERVICE_ROLE_KEY for direct PostgreSQL access
- **Permissions**: Limited to INSERT on market_data_candles table only
- **Connection**: Direct asyncpg connection using Supabase PostgreSQL URL
- **Transaction Handling**: Proper transaction management for batch operations
- **Error Handling**: Database constraint violations (unique key conflicts)
- **Performance**: Connection pooling for optimal concurrent request handling
[Source: architecture/11-backend-architecture.md#database-interaction]

### Security Implementation
API Key authentication and security measures:
- **X-API-KEY Header**: Validate against MT5_API_KEY environment variable
- **Middleware**: Custom FastAPI dependency for authentication
- **Error Responses**: Secure error messages that don't leak system information
- **Input Validation**: Comprehensive Pydantic validation to prevent injection attacks
- **Rate Limiting**: Consider implementing rate limiting for production deployment
- **CORS Configuration**: Proper CORS setup for external MT5 EA access
[Source: architecture/11-backend-architecture.md#service-authentication]

### Project Structure Notes
The FastAPI service follows the established template pattern with clear separation of API routes, business logic, and database operations. The endpoint integrates with the existing Supabase PostgreSQL database using service_role credentials, maintaining security isolation from user authentication. The implementation supports the architecture's requirement for external MT5 EA data ingestion while preparing for internal Next.js frontend data querying.

## Testing

**Test Framework:** Pytest with FastAPI TestClient for API endpoint testing

**Test File Locations:**
- Unit tests: `backend/src/app/tests/api/routes/test_candles.py`
- Integration tests: `backend/src/app/tests/api/test_candle_integration.py`
- Models tests: `backend/src/app/tests/models/test_candle.py`
- Database tests: `backend/src/app/tests/db/test_candle_operations.py`

**Testing Standards:**
- High code coverage for all endpoint logic and data validation
- Use FastAPI TestClient for endpoint testing with proper authentication
- Mock database connections for unit tests, use test database for integration
- Test all error scenarios and edge cases

**Specific Testing Requirements:**
- Test POST /api/v1/candles endpoint with valid X-API-KEY header
- Test authentication failure scenarios (missing, invalid API key)
- Test request validation for all candle data fields (symbol, timeframe, OHLC, volume)
- Test timestamp format validation and parsing
- Test batch candle data processing (multiple candles in single request)
- Test database insertion with unique constraint handling
- Test duplicate data handling (should not fail, should ignore duplicates)
- Test malformed JSON request handling
- Test database connection failure scenarios
- Test transaction rollback for failed batch operations
- Test CORS configuration for external access
- Test endpoint response format and HTTP status codes
- Integration test with actual Supabase test database connection

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-04 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_