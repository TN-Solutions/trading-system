# Story 3.1: Build Analysis Template Functionality

## Status
Draft

## Story
**As a** trader,
**I want** to save a report structure as a template,
**so that** I can quickly start a new analysis.

## Acceptance Criteria
1. Has a "Save as Template" button
2. Saves the structure to the DB
3. Allows creating a new report from a template

## Tasks / Subtasks
- [ ] Create database tables for analysis templates (AC: 2)
  - [ ] Create `analysis_templates` table with proper schema and RLS policies
  - [ ] Create `analysis_template_blocks` table for template block structures
  - [ ] Set up foreign key relationships between templates and users
  - [ ] Test template data creation and retrieval with proper user access controls
- [ ] Build template management components (AC: 1, 3)
  - [ ] Create "Save as Template" button in report editor
  - [ ] Build template selection dialog for creating new reports
  - [ ] Create template name input form with validation
  - [ ] Implement template listing interface for selection
- [ ] Implement template CRUD operations (AC: 2, 3)
  - [ ] Create server actions for saving report structure as template
  - [ ] Build server action for creating new report from template
  - [ ] Add template deletion functionality for template management
  - [ ] Implement template listing with user filtering
- [ ] Integrate template functionality into report workflow (AC: 1, 3)
  - [ ] Add template save button to report editor toolbar
  - [ ] Integrate template selection into new report creation flow
  - [ ] Update report creation page to support template-based initialization
  - [ ] Add template management page for organizing saved templates
- [ ] Add comprehensive testing (Required by testing strategy)
  - [ ] Unit tests for template components and validation logic
  - [ ] Integration tests for template CRUD operations with database
  - [ ] E2E tests for save template and create from template workflows

## Dev Notes

### Previous Story Insights
From Story 2.2: The interactive report editor is complete with block-based analysis structure. Reports contain analysis blocks with timeframes, bias, chart_data, and notes. The feature-based architecture is established in `features/reports/` with server actions pattern working well. Database operations use Supabase client through Next.js Server Actions with RLS policies for security. The report editor components are functional with add/delete block capabilities.

### Data Models
Template system requires new data models to store report structures:

**Analysis Template Model:**
- `id`: uuid (Primary key)
- `user_id`: uuid (Foreign key to auth.users for RLS)
- `name`: text (Template name provided by user)
- `description`: text (Optional template description)
- `created_at`: timestamp (Creation timestamp)
- `updated_at`: timestamp (Last update timestamp)

**Analysis Template Block Model:**
- `id`: uuid (Primary key)
- `template_id`: uuid (Foreign key to analysis_templates)
- `user_id`: uuid (Foreign key to auth.users for RLS simplification)
- `timeframe`: text (Chart timeframe e.g., 'H4', 'D1')
- `is_primary`: boolean (Marks if this is the primary analysis timeframe)
- `bias`: text (Default bias: 'bullish', 'bearish', 'neutral')
- `notes_template`: text (Template text for notes field)
- `order_index`: integer (Order of blocks in template)
- `created_at`: timestamp (Creation timestamp)

Templates capture the structure of analysis blocks without chart_data or snapshot_image_url since these are analysis-specific. When creating from template, new empty analysis blocks are created with the template structure.

### API Specifications
Template operations use Supabase client library through Next.js Server Actions:
- **Save Template**: Extract report structure → Create template record → Create template blocks
- **Create from Template**: Fetch template and blocks → Create new report → Create analysis blocks from template
- **List Templates**: Query user's templates with block count for selection interface
- **Delete Template**: Remove template and associated template blocks (CASCADE)
- RLS policies ensure users can only access their own templates: `(auth.uid() = user_id)`
- Template queries need proper joins to include block count and template structure details
[Source: architecture/11-backend-architecture.md#authentication-and-authorization-architecture]

### Component Specifications
Template functionality requires new UI components integrated into existing report editor:

**Save Template Components:**
- Save as Template button in report editor toolbar
- Template name input dialog with description field
- Success feedback for template creation

**Create from Template Components:**
- Template selection dialog with template list
- Template preview showing block structure
- Integration into new report creation flow

Use Shadcn-ui components for consistency:
- Dialog components for template name input and selection
- Button components for save template and create from template actions
- Form components for template name and description input
- Card components for template list display
- Table components for template management page

Follow feature-based architecture with components in `features/reports/`:
- Template components in `features/reports/components/templates/`
- Template server actions in `features/reports/actions/template-actions.ts`
- Template service layer in `features/reports/services/template-service.ts`
[Source: architecture/10-frontend-architecture.md#routing-and-component-architecture and architecture/6-components.md]

### File Locations
Based on established project structure:
- Template components: `frontend/src/features/reports/components/templates/`
  - `save-template-dialog.tsx` - Dialog for saving report as template
  - `template-selection-dialog.tsx` - Dialog for selecting template when creating report
  - `template-list.tsx` - Component for displaying template list
- Template server actions: `frontend/src/features/reports/actions/template-actions.ts`
- Template service: `frontend/src/features/reports/services/template-service.ts`
- Template management page: `frontend/src/app/dashboard/templates/page.tsx`
- Template types: `frontend/src/types/template.ts`
- Updated report editor: `frontend/src/features/reports/components/report-editor.tsx`
- Updated new report flow: `frontend/src/features/reports/page-views/report-listing-view.tsx`
[Source: architecture/12-source-tree.md and architecture/10-frontend-architecture.md]

### Testing Requirements
Follow the established testing pyramid approach:
- **Unit Tests**: Jest + React Testing Library for template components
- **Integration Tests**: Test template CRUD flows with MSW for Supabase API mocking
- **E2E Tests**: Playwright for complete template save and create workflows
- **Test Coverage**: High coverage required for template business logic
- **Test Locations**:
  - Unit: `frontend/src/features/reports/components/templates/__tests__/`
  - Integration: `frontend/src/features/reports/__tests__/templates/`
  - E2E: `frontend/tests/e2e/reports/templates.spec.ts`
[Source: architecture/15-coding-standards.md#testing-strategy]

### Technical Constraints
- TypeScript 5.x with strict mode and full type safety for template models
- Next.js 14.x App Router architecture with server actions pattern
- Supabase integration with Row Level Security for template access control
- Input validation on both client and server sides for template names and descriptions
- Follow established naming conventions: PascalCase for components, camelCase for functions, snake_case for DB
- No business logic in components - use service/action layer pattern
- Proper error handling and loading states for template operations
- State management with Zustand if complex template selection state needed
[Source: architecture/3-tech-stack.md and architecture/15-coding-standards.md#coding-standards]

### Database Schema Requirements
New database tables needed for template functionality:

**Analysis Templates Table:**
```sql
CREATE TABLE public.analysis_templates (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
ALTER TABLE public.analysis_templates ENABLE ROW LEVEL SECURITY;
```

**Analysis Template Blocks Table:**
```sql
CREATE TABLE public.analysis_template_blocks (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id uuid NOT NULL REFERENCES public.analysis_templates(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    timeframe TEXT NOT NULL,
    is_primary BOOLEAN NOT NULL DEFAULT false,
    bias TEXT NOT NULL DEFAULT 'neutral',
    notes_template TEXT,
    order_index INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
ALTER TABLE public.analysis_template_blocks ENABLE ROW LEVEL SECURITY;
```

RLS policies needed:
- Templates: Users can only access their own templates
- Template blocks: Users can only access blocks from their own templates
[Source: architecture/9-database-schema.md pattern]

### Security Requirements
Template functionality must follow established security patterns:
- **Row Level Security**: All template tables must have RLS enabled with user_id filtering
- **Server-side Validation**: Template names and descriptions must be validated on server
- **Input Sanitization**: Prevent XSS attacks in template names and descriptions
- **User Authorization**: Verify user ownership before template operations
- **Template Sharing Prevention**: Ensure templates cannot be accessed across users
[Source: architecture/15-coding-standards.md#security-requirements]

### Performance Considerations
Template operations should be optimized for user experience:
- **Database Indexes**: Add indexes on user_id for template queries
- **Pagination**: Template listing should support pagination for users with many templates
- **Caching**: Consider caching frequently accessed templates
- **Bulk Operations**: Optimize template creation from reports with multiple blocks
- **Query Optimization**: Use efficient joins when fetching template with blocks
[Source: architecture/15-coding-standards.md#performance-optimization]

### Project Structure Notes
Template functionality extends the existing reports feature following established patterns. All file paths align with the feature-based architecture. The template system integrates seamlessly into the report workflow without disrupting existing functionality. Database migration will be required to add the new template tables with proper constraints and indexes.

## Testing

**Test Framework:** Jest with React Testing Library for unit/integration tests, Playwright for E2E tests

**Test File Locations:**
- Unit tests: `frontend/src/features/reports/components/templates/__tests__/`
- Integration tests: `frontend/src/features/reports/__tests__/templates/`
- E2E tests: `frontend/tests/e2e/reports/templates.spec.ts`

**Testing Standards:**
- High code coverage for template business logic and validation
- Mock Supabase calls using MSW for integration tests
- Test error states and edge cases for template operations
- E2E tests must cover complete template workflows

**Specific Testing Requirements:**
- Test template name validation (empty names, duplicate names, character limits)
- Test successful and failed template save operations
- Test template selection and report creation workflow
- Test template listing with proper user filtering (RLS enforcement)
- Test template deletion with confirmation workflow
- Test error handling for database failures and network issues
- Test template preview functionality showing block structure
- Test integration with existing report editor workflow
- Test template management page functionality
- Validate template structure preservation when creating reports

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-04 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_