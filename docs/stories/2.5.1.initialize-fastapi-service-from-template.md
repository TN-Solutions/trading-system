# Story 2.5.1: Initialize FastAPI Service from Template

## Status
Draft

## Story
**As a** developer,
**I want** to set up a new FastAPI application using the existing template in the `backend/` directory,
**so that** a foundation for the market data service is quickly created.

## Acceptance Criteria
1. The template is used
2. `backend/` directory is configured
3. FastAPI is running
4. Has a working `/health` endpoint
5. Docker configuration is functional for local development

## Tasks / Subtasks
- [ ] Review and understand existing FastAPI template structure (AC: 1)
  - [ ] Examine current backend template in `backend/src/` directory
  - [ ] Review template models, API structure, and configuration files
  - [ ] Understand Docker setup and development workflow
  - [ ] Document template capabilities and existing endpoints
- [ ] Configure FastAPI application for market data service (AC: 2, 3)
  - [ ] Update project configuration in `pyproject.toml` with market data service details
  - [ ] Configure FastAPI settings in `app/core/config.py` for market data endpoints
  - [ ] Remove unnecessary template models and endpoints (users, items, login)
  - [ ] Set up basic FastAPI app structure focused on market data operations
- [ ] Implement health endpoint (AC: 4)
  - [ ] Create `/health` endpoint in API routes
  - [ ] Add health check functionality with database connectivity test
  - [ ] Include service status and version information in health response
  - [ ] Test health endpoint accessibility and response format
- [ ] Configure Docker environment for local development (AC: 5)
  - [ ] Review and update Dockerfile for market data service requirements
  - [ ] Configure docker-compose for local development workflow
  - [ ] Set up environment variables for database connection
  - [ ] Test Docker build and container startup process
- [ ] Add comprehensive testing setup (Required by testing strategy)
  - [ ] Configure pytest for FastAPI market data service
  - [ ] Create unit tests for health endpoint
  - [ ] Set up test database configuration
  - [ ] Add test coverage reporting and CI integration

## Dev Notes

### Previous Story Insights
No previous stories in Epic 2.5. This is the foundational story for building the market data system. The existing FastAPI template in `backend/src/` provides a solid starting point with proper structure, Docker configuration, testing setup, and development workflow already established.

### Data Models
The market data service will use the existing `market_data_candles` table from the database schema:
- `market_data_candles`: Table with columns: id (BIGSERIAL), symbol (TEXT), timeframe (TEXT), timestamp (TIMESTAMPTZ), open/high/low/close (NUMERIC), volume (BIGINT), created_at (TIMESTAMPTZ)
- Unique constraint on (symbol, timeframe, timestamp) to prevent duplicate candle data
- RLS policies: authenticated users can SELECT, service_role can INSERT
[Source: architecture/9-database-schema.md#market-data-tables]

### API Specifications
The FastAPI service will implement two main endpoints as specified:
- **POST /api/v1/candles**: For MT5 EA to push OHLC data with X-API-KEY authentication
- **GET /api/v1/candles**: For Next.js backend to fetch historical data with query parameters (symbol, timeframe, from, to)
- **GET /health**: Basic health check endpoint to verify service status
- Authentication: X-API-KEY header for POST endpoint, internal service token for GET endpoint
[Source: architecture/5-api-specification.md#fastapi-market-data-service]

### Component Specifications
FastAPI Market Data Service architecture:
- **Framework**: FastAPI (Python) with Pydantic for data validation
- **Database Access**: Direct PostgreSQL connection using service_role credentials
- **Security**: API key authentication for external MT5 EA access
- **Environment**: Docker containerized with uv for dependency management
- **Testing**: Pytest with coverage reporting
[Source: architecture/11-backend-architecture.md#market-data-service-fastapi]

### File Locations
Based on established project structure and existing template:
- Main application: `backend/src/app/main.py`
- API routes: `backend/src/app/api/routes/` (new market data routes)
- Configuration: `backend/src/app/core/config.py`
- Models: `backend/src/app/models.py` (market data models)
- Tests: `backend/src/app/tests/api/routes/` (health endpoint tests)
- Docker: `backend/src/Dockerfile` and docker-compose configuration
- Dependencies: `backend/src/pyproject.toml`
[Source: architecture/12-source-tree.md#backend-directory]

### Testing Requirements
Follow established testing pyramid strategy:
- **Unit Tests**: Pytest for API endpoints, models, and business logic
- **Integration Tests**: Database connectivity and endpoint integration tests
- **Test Coverage**: High coverage required for API endpoints and data validation
- **Test Framework**: Pytest with FastAPI test client for endpoint testing
- **Test Database**: Separate test database configuration for isolated testing
- **Test Locations**:
  - Unit: `backend/src/app/tests/api/routes/test_health.py`
  - Integration: `backend/src/app/tests/api/test_market_data_integration.py`
  - Configuration: `backend/src/app/tests/conftest.py`
[Source: architecture/15-coding-standards.md#testing-strategy]

### Technical Constraints
- **Python Version**: 3.11+ as specified in tech stack
- **FastAPI**: Latest version for optimal performance and features
- **Database**: PostgreSQL 15.x via Supabase with service_role access
- **Dependency Management**: uv for fast Python package management
- **Container Runtime**: Docker for consistent development and deployment environment
- **Environment Variables**: Secure configuration for database credentials and API keys
- **CORS**: Proper CORS configuration for Next.js frontend communication
- **Logging**: Structured logging for debugging and monitoring
[Source: architecture/3-tech-stack.md#backend-technologies]

### Backend Template Analysis
Existing FastAPI template provides:
- Complete FastAPI application structure with main.py entry point
- Core configuration management in `app/core/config.py`
- API routing structure in `app/api/` with router organization
- Database models using SQLModel in `app/models.py`
- Authentication and security utilities in `app/core/security.py`
- Comprehensive testing setup with pytest and test utilities
- Docker configuration with development and production settings
- Alembic for database migrations
- Development scripts for testing, linting, and formatting
[Source: backend/src/ directory structure and README.md]

### Service Role Database Access
FastAPI service database configuration:
- Use service_role credentials for direct PostgreSQL access
- Limited permissions: INSERT and SELECT on market_data_candles table only
- No user authentication handling - focused solely on market data operations
- Direct database connection using asyncpg or psycopg2 driver
- Connection pooling for optimal performance
[Source: architecture/11-backend-architecture.md#database-interaction]

### Project Structure Notes
The FastAPI service sits in the `backend/` directory as specified in the unified project structure. The template follows established patterns with clear separation of concerns: API routes, core configuration, models, and testing. The Docker setup supports both development (with live reload) and production deployment. The service will integrate with the existing Supabase PostgreSQL database while maintaining independence from the Next.js frontend authentication system.

## Testing

**Test Framework:** Pytest with FastAPI test client for API endpoint testing

**Test File Locations:**
- Unit tests: `backend/src/app/tests/api/routes/`
- Integration tests: `backend/src/app/tests/api/`
- Configuration: `backend/src/app/tests/conftest.py`

**Testing Standards:**
- High code coverage for all API endpoints and business logic
- Use FastAPI test client for endpoint testing
- Mock database connections for unit tests
- Use test database for integration tests

**Specific Testing Requirements:**
- Test health endpoint response format and status codes
- Test FastAPI application startup and configuration
- Test Docker container build and startup process
- Test database connectivity from FastAPI service
- Test environment variable configuration
- Test API route registration and basic functionality
- Test error handling for missing configuration
- Test CORS configuration for frontend integration

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-04 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_