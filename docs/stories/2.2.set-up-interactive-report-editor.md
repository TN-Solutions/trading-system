# Story 2.2: Set up Interactive Report Editor

## Status
Draft

## Story
**As a** trader,
**I want** a block-based editor,
**so that** I can structure my analysis.

## Acceptance Criteria
1. Has an edit page `/reports/[reportId]`
2. Allows adding/deleting blocks
3. Entering a title
4. Selecting asset/methodology
5. Has a save button

## Tasks / Subtasks
- [ ] Create database table for analysis blocks (AC: 2)
  - [ ] Create `analysis_blocks` table with proper schema and RLS policies
  - [ ] Set up foreign key relationships to reports table
  - [ ] Test data creation and retrieval with proper user access controls
- [ ] Create report editor page route (AC: 1)
  - [ ] Create `/dashboard/reports/[reportId]` page component
  - [ ] Set up proper routing and dynamic parameter handling
  - [ ] Implement report data fetching for editor initialization
- [ ] Build report editor components (AC: 2, 3, 4, 5)
  - [ ] Create ReportEditor component with block management
  - [ ] Build AnalysisBlock component for individual blocks
  - [ ] Implement add/delete block functionality
  - [ ] Create report title editing interface
  - [ ] Build asset/methodology selection dropdowns
  - [ ] Add save report functionality with validation
- [ ] Implement analysis block CRUD operations (AC: 2)
  - [ ] Create server actions for analysis block operations
  - [ ] Implement create, update, delete block functionality
  - [ ] Add proper error handling and validation
  - [ ] Ensure blocks are properly linked to reports and users
- [ ] Create report editor view integration (AC: 1, 2, 3, 4, 5)
  - [ ] Build ReportEditorView component
  - [ ] Integrate all editor components
  - [ ] Add proper loading and error states
  - [ ] Implement form state management
- [ ] Add comprehensive testing (Required by testing strategy)
  - [ ] Unit tests for editor components
  - [ ] Integration tests for block CRUD flows
  - [ ] E2E tests for complete report editing workflow

## Dev Notes

### Previous Story Insights
From Story 2.1: Supabase Auth integration with RLS is complete and working. The authentication system is established. The project uses TypeScript strict mode, Next.js 14 App Router, and Shadcn-ui components. Testing infrastructure with Jest, React Testing Library, and Playwright is fully configured. The Report management feature provides the foundation with CRUD operations working well. Feature-based architecture with server actions pattern is established and working. The reports feature structure is already in place at `frontend/src/features/reports/`.

### Data Models
The AnalysisBlock model is defined with the following structure:
- `id`: uuid (Primary key)
- `report_id`: uuid (Foreign key to reports table)
- `user_id`: uuid (Foreign key to auth.users for RLS simplification)
- `timeframe`: text (Chart timeframe e.g., 'H4', 'D1')
- `is_primary`: boolean (Marks if this is the primary analysis timeframe)
- `bias`: text (Bias of the analysis: 'bullish', 'bearish', 'neutral')
- `chart_data`: jsonb (Data for chart drawings)
- `notes`: text (User's text notes)
- `snapshot_image_url`: text (Optional URL to a screenshot of the analysis)
- `created_at`: timestamp (Creation timestamp)
[Source: architecture/4-data-models.md#44-model-analysisblock]

The Report model structure includes:
- `id`: uuid (Primary key)
- `user_id`: uuid (Foreign key to auth.users)
- `asset_id`: uuid (Foreign key to assets table)
- `methodology_id`: uuid (Foreign key to methodologies table)
- `title`: text (Title of the report)
- `status`: text (Status: 'draft' or 'published')
- `created_at`: timestamp (Creation timestamp)
- `updated_at`: timestamp (Last update timestamp)
[Source: architecture/4-data-models.md#43-model-report]

### API Specifications
- Data operations use Supabase client library through Next.js Server Actions
- No traditional REST API - operations go through PostgreSQL with RLS
- Server Actions pattern: React component → Server Action → Supabase client → PostgreSQL
- RLS policies ensure users can only access their own analysis blocks: `(auth.uid() = user_id)`
- Analysis block queries need proper joins to include report details when needed
- Report updates need to handle title, asset_id, methodology_id changes
[Source: architecture/11-backend-architecture.md#113-authentication-and-authorization-architecture]

### Component Specifications
Report Editor component should manage complex state including:
- Current report data and analysis blocks array
- Form state for report title, asset, methodology selection
- Block editing state (add/delete operations)
- Save/auto-save functionality

Use Shadcn-ui components for consistent UI patterns:
- Form components for title and dropdowns
- Button components for add/delete/save actions
- Card components for analysis blocks
- Dialog components for confirmations

Follow feature-based architecture with components in `features/reports/`:
- Page views should be placed in `features/reports/page-views/`
- Server actions should be in `features/reports/actions/`
- Editor components in `features/reports/components/`
[Source: architecture/10-frontend-architecture.md#101-routing-and-component-architecture and architecture/6-components.md]

### File Locations
Based on project structure:
- Route page: `frontend/src/app/dashboard/reports/[reportId]/page.tsx`
- Editor view: `frontend/src/features/reports/page-views/report-editor-view.tsx`
- Main editor: `frontend/src/features/reports/components/report-editor.tsx`
- Analysis block component: `frontend/src/features/reports/components/analysis-block.tsx`
- Server actions: `frontend/src/features/reports/actions/analysis-block-actions.ts`
- Updated report actions: `frontend/src/features/reports/actions/report-actions.ts`
- Block service: `frontend/src/features/reports/services/analysis-block-service.ts`
[Source: architecture/12-source-tree.md and architecture/10-frontend-architecture.md]

### Testing Requirements
Follow the established testing pyramid:
- **Unit Tests**: Jest + React Testing Library for editor components
- **Integration Tests**: Test complete block CRUD flows with MSW for API mocking
- **E2E Tests**: Playwright for critical report editing workflows
- **Test Coverage**: High coverage required for business logic components
- **Test Locations**: 
  - Unit: `frontend/src/features/reports/components/__tests__/`
  - Integration: `frontend/src/features/reports/__tests__/`
  - E2E: `frontend/tests/e2e/reports/`
[Source: architecture/15-coding-standards.md#153-testing-strategy]

### Technical Constraints
- TypeScript 5.x with strict mode and full type safety
- Next.js 14.x App Router architecture
- Supabase integration with Row Level Security
- Input validation on both client and server sides
- Follow established naming conventions: PascalCase for components, camelCase for functions, snake_case for DB
- No business logic in components - use service/action layer
- Proper error handling and loading states required
- State management with Zustand for complex editor state
[Source: architecture/3-tech-stack.md and architecture/15-coding-standards.md#154-coding-standards]

### Database Schema
```sql
CREATE TABLE public.analysis_blocks (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    report_id uuid NOT NULL REFERENCES public.reports(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    timeframe TEXT NOT NULL,
    is_primary BOOLEAN NOT NULL DEFAULT false,
    bias TEXT NOT NULL, -- 'bullish', 'bearish', 'neutral'
    chart_data JSONB,
    notes TEXT,
    snapshot_image_url TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
ALTER TABLE public.analysis_blocks ENABLE ROW LEVEL SECURITY;
```
[Source: architecture/9-database-schema.md]

### Project Structure Notes
All file paths and component locations align with the established project structure. The report editor follows the same feature-based pattern as existing reports management, ensuring consistency across the application. The dynamic route `/reports/[reportId]` follows Next.js App Router conventions.

## Testing

**Test Framework:** Jest with React Testing Library for unit/integration tests, Playwright for E2E tests

**Test File Locations:**
- Unit tests: `frontend/src/features/reports/components/__tests__/`
- Integration tests: `frontend/src/features/reports/__tests__/`
- E2E tests: `frontend/tests/e2e/reports/`

**Testing Standards:**
- High code coverage for report editor business logic
- Mock Supabase calls using MSW for integration tests
- Test error states and edge cases
- E2E tests must cover complete report editing workflows

**Specific Testing Requirements:**
- Test form validation with invalid inputs (empty title, invalid asset/methodology selections)
- Test successful and failed analysis block CRUD operations
- Test add/delete block functionality with proper state management
- Test report title and metadata editing
- Test RLS enforcement (users can only edit their own reports and blocks)
- Test proper error handling and user feedback
- Test save functionality with validation
- Test editor state management and form persistence

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-03 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be populated by Dev Agent)

### Debug Log References
(To be populated by Dev Agent)

### Completion Notes List
(To be populated by Dev Agent)

### File List
(To be populated by Dev Agent)

## QA Results
(To be populated by QA Agent)