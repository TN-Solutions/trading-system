# Story 2.5.3: Build Candlestick Data Query Endpoint

## Status
Draft

## Story
**As a** developer,
**I want** to create a `GET /api/v1/candles` endpoint that accepts `symbol`, `resolution`, `from`, `to` parameters,
**so that** it can query and return candlestick data from the `market_data_candles` table.

## Acceptance Criteria
1. The endpoint works
2. Returns data in the format required by the charting library
3. Has error handling for when data is not found

## Tasks / Subtasks
- [ ] Create candlestick data query endpoint (AC: 1)
  - [ ] Implement `GET /api/v1/candles` endpoint in FastAPI routes
  - [ ] Add query parameter validation for symbol, timeframe, from, to
  - [ ] Set up secure internal authentication between Next.js and FastAPI
  - [ ] Add proper error handling for missing parameters
  - [ ] Configure endpoint for internal access only (not public)
- [ ] Implement data retrieval and formatting logic (AC: 2)
  - [ ] Create database query logic for market_data_candles table
  - [ ] Convert Unix timestamps to database timestamp format for querying
  - [ ] Format response data for klinecharts library compatibility
  - [ ] Handle pagination for large data sets
  - [ ] Optimize database queries with appropriate indexing
- [ ] Add comprehensive error handling (AC: 3)
  - [ ] Handle case when no data found for given parameters
  - [ ] Add validation for date range parameters (from < to)
  - [ ] Implement proper HTTP status codes (200, 400, 404, 500)
  - [ ] Add logging for query performance monitoring
  - [ ] Handle database connection errors gracefully
- [ ] Add comprehensive testing for the query endpoint (Required by testing strategy)
  - [ ] Create unit tests for query parameter validation
  - [ ] Add tests for data retrieval and formatting logic
  - [ ] Create integration tests for database query operations
  - [ ] Test error handling scenarios (no data, invalid parameters)
  - [ ] Add performance tests for large data sets

## Dev Notes

### Previous Story Insights
Story 2.5.2 established the data ingestion endpoint and database storage functionality. The market_data_candles table structure, database connection handling, and basic FastAPI service configuration are already in place. This story builds upon that foundation by adding the query capability needed by the frontend charting system.

### Data Models
The endpoint will query the existing `market_data_candles` table:
- **Table**: `market_data_candles` with columns: id (BIGSERIAL), symbol (TEXT), timeframe (TEXT), timestamp (TIMESTAMPTZ), open/high/low/close (NUMERIC), volume (BIGINT), created_at (TIMESTAMPTZ)
- **Query Pattern**: Filter by symbol, timeframe, and timestamp range (from <= timestamp <= to)
- **RLS Policies**: Authenticated users can SELECT, service_role has full access
- **Response Format**: Must convert to klinecharts-compatible format with timestamp in milliseconds
[Source: architecture/9-database-schema.md#market-data-tables]

### API Specifications
The GET endpoint follows the detailed specification:
- **Endpoint**: `GET /api/v1/candles`
- **Authentication**: Internal service authentication between Next.js and FastAPI (not public)
- **Query Parameters**: symbol (string), timeframe (string), from (integer Unix timestamp), to (integer Unix timestamp)
- **Response Format**: JSON array compatible with klinecharts library - timestamp in milliseconds, OHLC as numbers
- **Content Type**: application/json for response
- **Success Response**: 200 OK with candle data array, 404 if no data found
[Source: architecture/5-api-specification.md#fastapi-market-data-service]

### Component Specifications
FastAPI Market Data Service query functionality:
- **Framework**: FastAPI with async operations for optimal performance
- **Database Driver**: asyncpg for async PostgreSQL operations with connection pooling
- **Authentication**: Internal network security or shared secret token (not API key like ingestion)
- **Query Optimization**: Use database indexes on symbol, timeframe, timestamp for performance
- **Response Formatting**: Convert PostgreSQL TIMESTAMPTZ to Unix milliseconds for frontend
- **Error Handling**: Proper HTTP status codes and structured error responses
[Source: architecture/11-backend-architecture.md#market-data-service-fastapi]

### File Locations
Based on established FastAPI template structure:
- **Main Route**: `backend/src/app/api/routes/candles.py` (extend existing file from 2.5.2)
- **Database Operations**: `backend/src/app/db/candle_operations.py` (extend with query functions)
- **Response Models**: `backend/src/app/models/candle.py` (add response models)
- **Internal Auth**: `backend/src/app/core/security.py` (add internal service auth)
- **Tests**: `backend/src/app/tests/api/routes/test_candles_query.py` (new test file)
- **Integration Tests**: `backend/src/app/tests/api/test_candle_query_integration.py`
- **Environment Config**: `backend/src/app/core/config.py` (add internal service token)
[Source: architecture/12-source-tree.md#backend-directory]

### Testing Requirements
Follow established testing pyramid strategy:
- **Unit Tests**: Pytest for endpoint logic, parameter validation, data formatting
- **Integration Tests**: Database query operations with test database, end-to-end API calls
- **Test Coverage**: High coverage required for query logic and error handling
- **Test Framework**: Pytest with FastAPI TestClient for API testing
- **Test Database**: Use test database with sample market_data_candles data
- **Performance Testing**: Test query performance with large datasets
- **Security Testing**: Test internal authentication and access controls
[Source: architecture/15-coding-standards.md#testing-strategy]

### Technical Constraints
- **Python Version**: 3.11+ as specified in tech stack
- **FastAPI**: Latest version with automatic OpenAPI documentation generation
- **Database**: PostgreSQL 15.x via Supabase with authenticated user access (not service_role)
- **Connection Management**: Async database connections with proper pooling
- **Security**: Internal service authentication, not publicly accessible
- **Query Performance**: Efficient queries with appropriate database indexing
- **Data Format**: Response format must be compatible with klinecharts library
- **Date Handling**: Proper conversion between Unix timestamps and PostgreSQL TIMESTAMPTZ
[Source: architecture/3-tech-stack.md#backend-technologies]

### Database Query Strategy
Query optimization and data access patterns:
- **Connection**: Use authenticated user access (not service_role) for read operations
- **Indexes**: Ensure indexes exist on (symbol, timeframe, timestamp) for query performance
- **Query Pattern**: `SELECT timestamp, open, high, low, close, volume FROM market_data_candles WHERE symbol = ? AND timeframe = ? AND timestamp BETWEEN ? AND ? ORDER BY timestamp ASC`
- **Pagination**: Consider LIMIT/OFFSET for very large result sets
- **Performance**: Monitor query execution time and optimize as needed
- **Caching**: Consider future caching strategy for frequently requested data
[Source: architecture/11-backend-architecture.md#database-interaction]

### Frontend Integration Requirements
Preparation for Next.js frontend integration:
- **Chart Library**: Response format must be compatible with klinecharts library
- **Timestamp Format**: Convert database TIMESTAMPTZ to Unix milliseconds for JavaScript
- **Data Structure**: Array of objects with timestamp, open, high, low, close, volume fields
- **Error Handling**: Structured error responses that frontend can handle appropriately
- **Performance**: Fast response times for smooth chart rendering
- **Security**: Ensure endpoint is only accessible from authenticated Next.js server-side code
[Source: architecture/5-api-specification.md#frontend-integration]

### Project Structure Notes
The query endpoint complements the ingestion endpoint established in story 2.5.2, completing the full data flow from MT5 EA ingestion to frontend chart display. The endpoint uses authenticated user access rather than service_role, aligning with the read-only nature of the operation and preparing for integration with the Next.js frontend's user authentication system.

## Testing

**Test Framework:** Pytest with FastAPI TestClient for API endpoint testing

**Test File Locations:**
- Unit tests: `backend/src/app/tests/api/routes/test_candles_query.py`
- Integration tests: `backend/src/app/tests/api/test_candle_query_integration.py`
- Database tests: `backend/src/app/tests/db/test_candle_query_operations.py`
- Performance tests: `backend/src/app/tests/performance/test_candle_query_performance.py`

**Testing Standards:**
- High code coverage for all endpoint logic and data formatting
- Use FastAPI TestClient for endpoint testing with proper authentication
- Use test database with sample data for integration tests
- Mock database connections for unit tests when appropriate
- Test all error scenarios and edge cases

**Specific Testing Requirements:**
- Test GET /api/v1/candles endpoint with valid query parameters
- Test internal authentication mechanism (not public access)
- Test query parameter validation (symbol, timeframe, from, to)
- Test date range validation (from < to, valid timestamp formats)
- Test response format compatibility with klinecharts library
- Test empty result handling (no data found for parameters)
- Test database query optimization and performance
- Test large dataset handling and pagination
- Test invalid parameter combinations and edge cases
- Test database connection failure scenarios
- Test timestamp conversion from PostgreSQL to Unix milliseconds
- Integration test with actual Supabase test database connection
- Test concurrent request handling
- Test error response format and HTTP status codes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-04 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent_