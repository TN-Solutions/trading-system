# Story 2.3: Integrate Chart and Drawing Tools

## Status
Ready for Review

## Story
**As a** trader,
**I want** an interactive chart with drawing tools,
**so that** I can perform technical analysis.

## Acceptance Criteria
1. Chart library is integrated
2. Displays candle data
3. Has Trendline/Rectangle drawing tools
4. Drawn objects are saved

## Tasks / Subtasks
- [x] Install and integrate klinecharts library (AC: 1)
  - [x] Add klinecharts dependency to package.json
  - [x] Create dynamic import wrapper for performance optimization
  - [x] Set up basic charting component structure
- [x] Create chart service for market data fetching (AC: 2)
  - [x] Implement market data service client for FastAPI integration
  - [x] Create candle data fetching server actions
  - [x] Add proper error handling and caching for data requests
- [x] Build interactive chart component (AC: 1, 2)
  - [x] Create Chart component with klinecharts integration
  - [x] Implement candle data rendering from market data service
  - [x] Add loading states and error handling for chart display
  - [x] Configure chart styling and responsive behavior
- [x] Implement drawing tools functionality (AC: 3)
  - [x] Add trendline drawing tool with proper interaction handlers
  - [x] Add rectangle drawing tool with selection and modification capabilities
  - [x] Create drawing tool UI controls and toolbar
  - [x] Implement drawing state management with proper event handling
- [x] Integrate chart with analysis blocks (AC: 4)
  - [x] Enhance AnalysisBlock model to store chart_data with drawings
  - [x] Create chart drawing serialization/deserialization logic
  - [x] Update analysis block CRUD operations to handle chart data
  - [x] Integrate chart component into report editor workflow
- [x] Add comprehensive testing (Required by testing strategy)
  - [x] Unit tests for chart component and drawing tools
  - [x] Integration tests for chart data persistence
  - [x] E2E tests for complete chart interaction workflows

## Dev Notes

### Previous Story Insights
From Story 2.2: Interactive report editor with analysis blocks is complete and functional. Analysis blocks have `chart_data` JSONB field for storing drawing data. RLS policies are established. TypeScript strict mode, Next.js 14 App Router, and Shadcn-ui component patterns are well established. The feature-based architecture with server actions is working well. The report editor architecture provides the foundation for integrating chart functionality.

### Data Models
The AnalysisBlock model includes a `chart_data` field specifically designed for chart drawings:
- `chart_data`: jsonb (Data for chart drawings with structure compatible with klinecharts)
- Drawing structure defined as ChartDrawing interface with id, type ('trendline' | 'rectangle'), and points array
- Chart data will be serialized/deserialized when saving to PostgreSQL JSONB field
[Source: architecture/4-data-models.md#44-model-analysisblock]

### API Specifications
Chart data will be fetched from the internal FastAPI Market Data Service:
- **GET /api/v1/candles** endpoint for historical candlestick data
- Query parameters: symbol, timeframe, from (unix timestamp), to (unix timestamp)
- Response format compatible with klinecharts library: timestamp, open, high, low, close, volume
- Authentication through Next.js server-side calls only (not client-side)
- Chart data operations through Server Actions pattern: Component → Server Action → FastAPI service
[Source: architecture/5-api-specification.md and architecture/7-external-apis.md]

### Component Specifications
Chart component architecture following established patterns:
- **ChartComponent**: Main wrapper integrating klinecharts library
- **ChartService**: Service layer for market data API calls
- **Drawing Tools**: Trendline and Rectangle drawing implementations
- Use dynamic imports (`next/dynamic`) for klinecharts to optimize bundle size
- Chart component should be placed in `components/charts/` directory
- Integration with Zustand for complex drawing tool state management
- Use Shadcn-ui components for chart toolbar and controls
[Source: architecture/6-components.md#component-3-charting-component-frontend]

### File Locations
Based on established project structure:
- Chart wrapper: `frontend/src/components/charts/chart.tsx`
- Market data service: `frontend/src/lib/services/market-data-service.ts`
- Chart server actions: `frontend/src/features/reports/actions/chart-actions.ts`
- Chart integration in editor: Update `frontend/src/features/reports/components/analysis-block.tsx`
- Chart types: `frontend/src/types/chart.ts`
- Drawing tools: `frontend/src/components/charts/drawing-tools.tsx`
[Source: architecture/12-source-tree.md]

### Testing Requirements
Follow established testing pyramid strategy:
- **Unit Tests**: Jest + React Testing Library for chart components and drawing tools
- **Integration Tests**: Test chart data persistence and market data API integration with MSW
- **E2E Tests**: Playwright for complete chart interaction workflows
- **Test Coverage**: High coverage required for chart business logic and drawing operations
- **Test Locations**:
  - Unit: `frontend/src/components/charts/__tests__/`
  - Integration: `frontend/src/features/reports/__tests__/chart-integration.test.tsx`
  - E2E: `frontend/tests/e2e/reports/chart-interaction.spec.ts`
[Source: architecture/15-coding-standards.md#153-testing-strategy]

### Technical Constraints
- **klinecharts Library**: Specific charting library chosen for this project
- **Performance**: Use dynamic imports for chart library to avoid bundle size impact
- TypeScript 5.x with strict mode and full type safety for chart interactions
- Chart data format must be compatible with klinecharts library specifications
- Drawing objects must be serializable to JSONB format for database storage
- Server-side only access to market data API for security
- Follow established naming conventions: PascalCase for components, camelCase for functions
- RLS enforcement for chart data access through analysis blocks
[Source: architecture/3-tech-stack.md and architecture/15-coding-standards.md]

### Market Data Integration
Chart will integrate with custom FastAPI Market Data Service:
- Service provides historical candlestick data via GET /api/v1/candles
- Data format: `{ timestamp: number, open: number, high: number, low: number, close: number, volume: number }`
- Parameters: symbol (e.g., "EURUSD"), timeframe (e.g., "H1"), from/to unix timestamps
- Authentication handled through Next.js server actions, not client-side calls
- Error handling for data not found and service unavailability scenarios
[Source: architecture/5-api-specification.md#endpoint-get-apiv1candles]

### Drawing Tools Specifications
Chart drawing tools requirements:
- **Trendline Tool**: Allow drawing lines between two points with drag handles for modification
- **Rectangle Tool**: Allow drawing rectangles with corner drag handles for resizing
- Drawing state persistence in AnalysisBlock.chart_data as ChartDrawing[] format
- Drawing tools UI integrated with chart toolbar using Shadcn-ui components
- Drawing selection, modification, and deletion capabilities
- Export/import drawing state for database serialization
[Source: architecture/4-data-models.md#chartdrawing-interface]

### Project Structure Notes
The chart integration follows the established feature-based architecture. Chart components are placed in the general `components/charts/` directory as they may be reused across features. The integration with reports feature maintains separation of concerns with chart-specific actions in the reports feature actions directory. Dynamic importing ensures optimal performance by loading the heavy charting library only when needed.

## Testing

**Test Framework:** Jest with React Testing Library for unit/integration tests, Playwright for E2E tests

**Test File Locations:**
- Unit tests: `frontend/src/components/charts/__tests__/`
- Integration tests: `frontend/src/features/reports/__tests__/`
- E2E tests: `frontend/tests/e2e/reports/`

**Testing Standards:**
- High code coverage for chart interaction business logic
- Mock market data API calls using MSW for integration tests
- Test drawing tool interactions and state persistence
- E2E tests must cover complete chart analysis workflows

**Specific Testing Requirements:**
- Test chart rendering with different data sets and timeframes
- Test trendline drawing, modification, and deletion operations
- Test rectangle drawing with proper geometric constraints
- Test chart data serialization/deserialization for database storage
- Test market data fetching with error scenarios (API unavailable, invalid data)
- Test chart integration within analysis blocks workflow
- Test drawing persistence across report editor sessions
- Test chart responsive behavior and performance with large datasets

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-04 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No critical debugging issues encountered. All components integrated successfully with klinecharts v10.0.0-alpha5.

### Completion Notes List
- Successfully integrated klinecharts library with Next.js 14 using dynamic imports for optimal performance
- Implemented comprehensive chart component with real-time data fetching from FastAPI market data service
- Created trendline and rectangle drawing tools with proper state management and persistence
- Full integration with analysis blocks allowing chart data to be saved and loaded from PostgreSQL JSONB field
- Comprehensive test coverage including unit tests, integration tests, and E2E test specifications
- All acceptance criteria met: (1) Chart library integrated, (2) Displays candle data, (3) Has drawing tools, (4) Drawn objects are saved

### File List
**New Files Created:**
- `frontend/src/types/chart.ts` - Chart data types and interfaces
- `frontend/src/components/charts/chart.tsx` - Dynamic chart wrapper component
- `frontend/src/components/charts/chart-core.tsx` - Core klinecharts integration
- `frontend/src/components/charts/chart-toolbar.tsx` - Chart toolbar with drawing tools
- `frontend/src/components/charts/drawing-tools.ts` - Drawing tools utilities and overlays
- `frontend/src/components/charts/index.ts` - Chart components exports
- `frontend/src/lib/services/market-data-service.ts` - Market data API service
- `frontend/src/hooks/use-chart-data.ts` - Chart data management hook
- `frontend/src/features/reports/actions/chart-actions.ts` - Chart server actions

**Test Files Created:**
- `frontend/src/components/charts/__tests__/chart-toolbar.test.tsx` - Chart toolbar unit tests
- `frontend/src/components/charts/__tests__/drawing-tools.test.ts` - Drawing tools unit tests
- `frontend/src/lib/services/__tests__/market-data-service.test.ts` - Market data service tests
- `frontend/src/features/reports/__tests__/chart-integration.test.tsx` - Chart integration tests
- `frontend/tests/e2e/reports/chart-interaction.spec.ts` - E2E chart interaction tests

**Modified Files:**
- `frontend/package.json` - Added klinecharts dependency
- `frontend/src/features/reports/components/analysis-block.tsx` - Integrated chart component

## QA Results
_To be filled by QA agent_